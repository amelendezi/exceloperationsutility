<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Excel File Processor</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f4f4f4;
    }
    h1 {
      text-align: center;
      color: #333;
    }
    .tab-container {
      overflow: hidden;
      background-color: #ddd;
      border-radius: 8px 8px 0 0;
      height: 46px;
    }
    .tab-container button {
      background-color: #FFF9C4;
      border: none;
      outline: none;
      cursor: pointer;
      padding: 14px 16px;
      transition: 0.3s;
      font-size: 16px;
      border-bottom-left-radius: 8px;
      border-bottom-right-radius: 8px;
      width: 120px;
      float: left;
      margin-right: 2px;
      text-align: center;
    }
    .tab-container button.file-selection-tab {
      width: 180px;
    }
    .tab-container button:hover {
      background-color: #FFECB3;
    }
    .tab-container button.active {
      background-color: #FFC107;
      color: white;
    }
    .tab-container button.data-tab {
      display: none;
      background-color: #C8E6C9;
      color: #333;
    }
    .tab-container button.data-tab:hover {
      background-color: #B2DFDB;
    }
    .tab-container button.data-tab.active {
      background-color: #4CAF50;
      color: white;
    }
    .tab-content {
      display: none;
      padding: 20px;
      background-color: white;
      border-radius: 0 0 8px 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .tab-content.active {
      display: block;
    }
    .upload-container {
      background-color: white;
      padding: 20px;
    }
    .instructions {
      margin-bottom: 20px;
      color: #333;
      line-height: 1.6;
    }
    .file-input {
      margin: 20px 0;
      display: block;
      position: relative;
    }
    .file-input-table {
      width: 100%;
      border-collapse: collapse;
    }
    .file-input-table td {
      padding: 10px 20px 10px 0;
      vertical-align: middle;
    }
    input[type="file"] {
      font-size: 14px;
      color: #333;
    }
    input[type="file"]::-webkit-file-upload-button {
      background-color: #B0C4DE;
      padding: 8px 12px;
      border-radius: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      border: none;
      cursor: pointer;
      color: #333;
      font-size: 14px;
    }
    input[type="file"]::-webkit-file-upload-button:hover {
      background-color: #A3BFFA;
    }
    .check-mark {
      color: #3c763d;
      font-size: 16px;
      margin-left: 10px;
      display: none;
    }
    .row-count {
      font-size: 14px;
      color: #666;
      margin-left: 5px;
      display: none;
    }
    .drag-area {
      border: 2px dashed #B0C4DE;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      color: #666;
      font-size: 14px;
      margin-top: 10px;
      cursor: pointer;
      transition: background-color: 0.3s;
    }
    .drag-area.drag-over {
      background-color: #E6EFFF;
    }
    .schema-box {
      margin-top: 20px;
      padding: 15px;
      border-radius: 8px;
      text-align: left;
      font-size: 14px;
      border: none;
      display: none;
    }
    .schema-box.processed {
      border: 1px solid: #ccc;
      display: block;
    }
    .warning {
      color: #e65100;
      margin-bottom: 10px;
    }
    .warning-detail {
      color: #e65100;
      margin-top: 5px;
      margin-left: 20px;
    }
    .error {
      color: #a94442;
      margin-bottom: 10px;
    }
    .schema-table {
      width: 100%;
      border-collapse: collapse;
    }
    .schema-table th, .schema-table td {
      padding: 8px;
      text-align: left;
      color: #666;
    }
    .schema-table th {
      font-weight: bold;
      color: #333;
    }
    .schema-table td.different {
      color: #a94442;
      font-weight: bold;
    }
    .sub-tab-container {
      overflow: hidden;
      background-color: #ddd;
      border-radius: 0 0 6px 6px;
      height: 38px;
      margin-bottom: 10px;
    }
    .sub-tab-container button {
      background-color: #e0e0e0;
      border: none;
      outline: none;
      cursor: pointer;
      padding: 10px 12px;
      transition: 0.3s;
      font-size: 14px;
      border-bottom-left-radius: 6px;
      border-bottom-right-radius: 6px;
      width: 100px;
      float: left;
      margin-right: 2px;
      text-align: center;
    }
    .sub-tab-container button:hover {
      background-color: #d0d0d0;
    }
    .sub-tab-container button.active {
      background-color: #2196F3;
      color: white;
    }
    .sub-tab-content {
      display: none;
    }
    .sub-tab-content.active {
      display: block;
    }
    .data-view-box {
      padding: 15px;
      border-radius: 8px;
      border: 1px solid: #ccc;
      background-color: white;
      height: calc(80vh - 160px);
      overflow-y: auto;
      overflow-x: auto;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .data-view-header {
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .data-view-header input {
      padding: 8px;
      flex-grow: 1;
      border: 1px solid: #ccc;
      border-radius: 4px;
      font-size: 14px;
    }
    .data-view-header .row-count {
      display: inline;
      font-size: 14px;
      color: #666;
    }
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }
    .data-table th, .data-table td {
      padding: 8px;
      border: 1px solid: #ddd;
      text-align: left;
      color: #666;
      white-space: nowrap;
    }
    .data-table th {
      background-color: #f4f4f4;
      font-weight: bold;
      color: #333;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .highlight {
      background-color: #FFFF99;
    }
  </style>
</head>
<body>
  <h1>Excel File Processor</h1>
  <div class="tab-container">
    <button class="tab-link file-selection-tab active" onclick="openTab(event, 'FileSelection')">File Selection</button>
    <button id="dataTab" class="tab-link data-tab" onclick="openTab(event, 'Data')">Data</button>
  </div>

  <div id="FileSelection" class="tab-content active">
    <div class="upload-container">
      <div class="instructions">
        Please upload two versions of the Excel files: the old version and the new version. 
        Each file must have a first row containing unique column headers. Subsequent rows should contain the data. 
        Only the first sheet of each Excel file will be processed; all other sheets will be discarded.
      </div>
      <table class="file-input-table">
        <tr>
          <td>
            <label for="file1" class="file-input">
              Old File:
              <input type="file" id="file1" accept=".xlsx">
              <span id="check1" class="check-mark">✔</span>
              <span id="rowCount1" class="row-count"></span>
            </label>
            <div id="dragArea1" class="drag-area">Drag file here</div>
          </td>
          <td>
            <label for="file2" class="file-input">
              New File:
              <input type="file" id="file2" accept=".xlsx">
              <span id="check2" class="check-mark">✔</span>
              <span id="rowCount2" class="row-count"></span>
            </label>
            <div id="dragArea2" class="drag-area">Drag file here</div>
          </td>
          <td></td>
        </tr>
      </table>
      <div id="messages"></div>
      <div id="schema" class="schema-box">
        <table id="schema-table" class="schema-table"></table>
      </div>
    </div>
  </div>
  <div id="Data" class="tab-content">
    <div class="sub-tab-container">
      <button class="sub-tab-link active" onclick="openSubTab(event, 'OldData')">Old Data</button>
      <button class="sub-tab-link" onclick="openSubTab(event, 'NewData')">New Data</button>
    </div>
    <div id="OldData" class="sub-tab-content active">
      <div class="data-view-box">
        <div class="data-view-header">
          <input type="text" id="oldDataSearch" placeholder="Search old data...">
          <span id="oldDataRowCount" class="row-count"></span>
        </div>
        <table id="oldDataTable" class="data-table"></table>
      </div>
    </div>
    <div id="NewData" class="sub-tab-content">
      <div class="data-view-box">
        <div class="data-view-header">
          <input type="text" id="newDataSearch" placeholder="Search new data...">
          <span id="newDataRowCount" class="row-count"></span>
        </div>
        <table id="newDataTable" class="data-table"></table>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    let data1 = null;
    let data2 = null;

    function openTab(evt, tabName) {
      const tabContents = document.getElementsByClassName("tab-content");
      for (let i = 0; i < tabContents.length; i++) {
        tabContents[i].classList.remove("active");
      }
      const tabLinks = document.getElementsByClassName("tab-link");
      for (let i = 0; i < tabLinks.length; i++) {
        tabLinks[i].classList.remove("active");
      }
      document.getElementById(tabName).classList.add("active");
      evt.currentTarget.classList.add("active");
    }

    function openSubTab(evt, subTabName) {
      const subTabContents = document.getElementsByClassName("sub-tab-content");
      for (let i = 0; i < subTabContents.length; i++) {
        subTabContents[i].classList.remove("active");
      }
      const subTabLinks = document.getElementsByClassName("sub-tab-link");
      for (let i = 0; i < subTabLinks.length; i++) {
        subTabLinks[i].classList.remove("active");
      }
      document.getElementById(subTabName).classList.add("active");
      evt.currentTarget.classList.add("active");
      renderSubTabData(subTabName);
    }

    function updateMessages(messages, isError = false, isWarning = false) {
      const messagesDiv = document.getElementById('messages');
      messagesDiv.innerHTML = '';

      messages.forEach(message => {
        const messageDiv = document.createElement('div');
        messageDiv.textContent = message.message || message;
        if (isError) {
          messageDiv.className = 'error';
        } else if (isWarning) {
          messageDiv.className = message.isDetail ? 'warning-detail' : 'warning';
        }
        messagesDiv.appendChild(messageDiv);
      });
    }

    function updateSchema(headers1, headers2, uniqueToFile1, uniqueToFile2) {
      const schemaDiv = document.getElementById('schema');
      const schemaTable = document.getElementById('schema-table');
      schemaTable.innerHTML = '';
      schemaDiv.classList.add('processed');

      const headerRow = document.createElement('tr');
      const th1 = document.createElement('th');
      const th2 = document.createElement('th');
      th1.textContent = 'Old File Columns';
      th2.textContent = 'New File Columns';
      headerRow.appendChild(th1);
      headerRow.appendChild(th2);
      schemaTable.appendChild(headerRow);

      const maxLength = Math.max(headers1.length, headers2.length);
      for (let i = 0; i < maxLength; i++) {
        const row = document.createElement('tr');
        const td1 = document.createElement('td');
        const td2 = document.createElement('td');
        td1.textContent = headers1[i] || '';
        td2.textContent = headers2[i] || '';
        if (headers1[i] && uniqueToFile1.includes(headers1[i])) {
          td1.classList.add('different');
        }
        if (headers2[i] && uniqueToFile2.includes(headers2[i])) {
          td2.classList.add('different');
        }
        row.appendChild(td1);
        row.appendChild(td2);
        schemaTable.appendChild(row);
      }
    }

    function renderDataTable(data, headers, tableId, searchTerm = '') {
      const dataTable = document.getElementById(tableId);
      dataTable.innerHTML = '';

      const headerRow = document.createElement('tr');
      headers.forEach(header => {
        const th = document.createElement('th');
        th.textContent = header;
        headerRow.appendChild(th);
      });
      dataTable.appendChild(headerRow);

      const filteredData = searchTerm
        ? data.filter(row => 
            Object.values(row).some(value => 
              value && value.toString().toLowerCase().includes(searchTerm.toLowerCase())
            )
          )
        : data;

      filteredData.forEach(row => {
        const dataRow = document.createElement('tr');
        headers.forEach(header => {
          const td = document.createElement('td');
          let cellContent = row[header] || '';
          if (searchTerm && cellContent) {
            const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            cellContent = cellContent.toString().replace(regex, '<span class="highlight">$1</span>');
            td.innerHTML = cellContent;
          } else {
            td.textContent = cellContent;
          }
          dataRow.appendChild(td);
        });
        dataTable.appendChild(dataRow);
      });
    }

    function renderSubTabData(subTabName) {
      if (subTabName === 'OldData' && data1) {
        const headers = Object.keys(data1[0] || {});
        document.getElementById('oldDataRowCount').textContent = `${data1.length} rows`;
        renderDataTable(data1, headers, 'oldDataTable', document.getElementById('oldDataSearch').value);
      } else if (subTabName === 'NewData' && data2) {
        const headers = Object.keys(data2[0] || {});
        document.getElementById('newDataRowCount').textContent = `${data2.length} rows`;
        renderDataTable(data2, headers, 'newDataTable', document.getElementById('newDataSearch').value);
      }
    }

    function hideDataView() {
      document.getElementById('oldDataTable').innerHTML = '';
      document.getElementById('newDataTable').innerHTML = '';
      document.getElementById('oldDataSearch').value = '';
      document.getElementById('newDataSearch').value = '';
      document.getElementById('oldDataRowCount').textContent = '';
      document.getElementById('newDataRowCount').textContent = '';
    }

    function toggleDataTab(show) {
      const dataTab = document.getElementById('dataTab');
      dataTab.style.display = show ? 'inline-block' : 'none';
    }

    async function readExcelFile(file) {
      try {
        const arrayBuffer = await file.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];

        // Get the range of the worksheet
        const range = XLSX.utils.decode_range(worksheet['!ref']);
        const headers = [];
        const firstRow = [];

        // Read the first row to extract headers, ignoring empty cells
        for (let col = range.s.c; col <= range.e.c; col++) {
          const cellAddress = XLSX.utils.encode_cell({ r: range.s.r, c: col });
          const cell = worksheet[cellAddress];
          const value = cell ? cell.v : '';
          if (value !== '' && value !== null && value !== undefined) {
            headers.push(value.toString());
          } else {
            headers.push(null);
          }
          firstRow.push(value);
        }

        // Filter out null headers to get non-empty headers
        const validHeaders = headers.filter(h => h !== null);

        // Convert sheet to JSON, starting from the second row to skip headers
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { 
          header: validHeaders, 
          defval: '',
          range: { s: { c: range.s.c, r: range.s.r + 1 }, e: range.e } // Start from row 2
        });

        // Map data to ensure only valid headers are included
        const mappedData = jsonData.map(row => {
          const newRow = {};
          validHeaders.forEach(header => {
            newRow[header] = row[header] || '';
          });
          return newRow;
        });

        return { data: mappedData, headers: validHeaders };
      } catch (error) {
        throw new Error(`Error reading ${file.name}: ${error.message}`);
      }
    }

    function compareHeaders(headers1, headers2, fileName1, fileName2) {
      const uniqueToFile1 = headers1.filter(h => !headers2.includes(h));
      const uniqueToFile2 = headers2.filter(h => !headers1.includes(h));

      if (uniqueToFile1.length === 0 && uniqueToFile2.length === 0) {
        return { isConsistent: true, uniqueToFile1: [], uniqueToFile2: [] };
      }

      const messages = ['Warning: The uploaded files have different column headers.'];
      
      if (uniqueToFile1.length > 0) {
        messages.push({
          message: `Old file (${fileName1}) contains columns not present in the new file: ${uniqueToFile1.join(', ')}.`,
          isDetail: true
        });
      }
      
      if (uniqueToFile2.length > 0) {
        messages.push({
          message: `New file (${fileName2}) contains columns not present in the old file: ${uniqueToFile2.join(', ')}.`,
          isDetail: true
        });
      }

      return { isConsistent: false, messages, uniqueToFile1, uniqueToFile2 };
    }

    async function processFiles() {
      const fileInput1 = document.getElementById('file1');
      const fileInput2 = document.getElementById('file2');
      const rowCount1 = document.getElementById('rowCount1');
      const rowCount2 = document.getElementById('rowCount2');

      if (!fileInput1.files.length || !fileInput2.files.length) {
        updateMessages(['Please upload both Excel files.'], true);
        document.getElementById('schema').classList.remove('processed');
        rowCount1.style.display = 'none';
        rowCount2.style.display = 'none';
        hideDataView();
        toggleDataTab(false);
        return;
      }

      try {
        const file1Result = await readExcelFile(fileInput1.files[0]);
        const file2Result = await readExcelFile(fileInput2.files[0]);
        data1 = file1Result.data;
        data2 = file2Result.data;

        rowCount1.textContent = `${data1.length} rows`;
        rowCount2.textContent = `${data2.length} rows`;
        rowCount1.style.display = 'inline';
        rowCount2.style.display = 'inline';

        const headerComparison = compareHeaders(
          file1Result.headers,
          file2Result.headers,
          fileInput1.files[0].name,
          fileInput2.files[0].name
        );

        updateSchema(
          file1Result.headers,
          file2Result.headers,
          headerComparison.uniqueToFile1 || [],
          headerComparison.uniqueToFile2 || []
        );

        if (!headerComparison.isConsistent) {
          updateMessages(headerComparison.messages, false, true);
        } else {
          updateMessages([]);
        }

        toggleDataTab(true);
        renderSubTabData('OldData');

        console.log('File 1 Data:', data1);
        console.log('File 2 Data:', data2);
      } catch (error) {
        updateMessages([error.message], true);
        document.getElementById('schema').classList.remove('processed');
        rowCount1.style.display = 'none';
        rowCount2.style.display = 'none';
        hideDataView();
        toggleDataTab(false);
      }
    }

    function handleDragOver(e) {
      e.preventDefault();
      e.stopPropagation();
      e.currentTarget.classList.add('drag-over');
    }

    function handleDragLeave(e) {
      e.preventDefault();
      e.stopPropagation();
      e.currentTarget.classList.remove('drag-over');
    }

    function handleDrop(e, fileInputId) {
      e.preventDefault();
      e.stopPropagation();
      e.currentTarget.classList.remove('drag-over');

      const files = e.dataTransfer.files;
      if (files.length > 0 && files[0].name.endsWith('.xlsx')) {
        const fileInput = document.getElementById(fileInputId);
        fileInput.files = files;
        const changeEvent = new Event('change', { bubbles: true });
        fileInput.dispatchEvent(changeEvent);
      }
    }

    document.getElementById('file1').addEventListener('change', function() {
      const checkMark = document.getElementById('check1');
      checkMark.style.display = this.files.length > 0 ? 'inline' : 'none';
      hideDataView();
      if (this.files.length > 0 && document.getElementById('file2').files.length > 0) {
        processFiles();
      }
    });

    document.getElementById('file2').addEventListener('change', function() {
      const checkMark = document.getElementById('check2');
      checkMark.style.display = this.files.length > 0 ? 'inline' : 'none';
      hideDataView();
      if (this.files.length > 0 && document.getElementById('file1').files.length > 0) {
        processFiles();
      }
    });

    document.getElementById('oldDataSearch').addEventListener('input', function() {
      if (data1) {
        const headers = Object.keys(data1[0] || {});
        renderDataTable(data1, headers, 'oldDataTable', this.value);
      }
    });

    document.getElementById('newDataSearch').addEventListener('input', function() {
      if (data2) {
        const headers = Object.keys(data2[0] || {});
        renderDataTable(data2, headers, 'newDataTable', this.value);
      }
    });

    const dragArea1 = document.getElementById('dragArea1');
    const dragArea2 = document.getElementById('dragArea2');

    dragArea1.addEventListener('dragover', handleDragOver);
    dragArea1.addEventListener('dragleave', handleDragLeave);
    dragArea1.addEventListener('drop', (e) => handleDrop(e, 'file1'));

    dragArea2.addEventListener('dragover', handleDragOver);
    dragArea2.addEventListener('dragleave', handleDragLeave);
    dragArea2.addEventListener('drop', (e) => handleDrop(e, 'file2'));
  </script>
</body>
</html>